#!/usr/bin/env bash
set -euo pipefail

STOW_TARGETS=(
  "root:/"
  "home:${HOME}"
)

print_help() {
cat << HELP
Usage: $0 COMMAND [OPTIONS...]
       $0 COMMAND [OPTIONS...] -p PROGRAM ... -p PROGRAM

A tool for managing dotfile configurations using GNU Stow. By default, only the
installed programs will get their dotfile configurations stowed.

Commands:
    up      Stow the dotfile configurations.
    down    Unstow the dotfile configurations.
    list    List available programs. By default, only installed programs are
            listed. Use --force to list all.

Options:
    -d, --dir DOTFILE_DIR   Set the dotfile directory to DOTFILE_DIR (default is
                            current directory). This directory must contain all
                            the dotfile configurations to stow/unstow. Dotfile
                            configurations must be laid out by target, then by
                            program (e.g. a ".bashrc" for "bash" must be placed
                            in "\$DOTFILE_DIR/home/bash/.bashrc"). There are two
                            supported targets: "root" and "home", respectively
                            pointing at "/" and "\$HOME".
    -p, --program PROGRAM   Stow/Unstow only the specified PROGRAM's dotfile
                            configurations. With this option, PROGRAM does not
                            have to be installed for stowing to be done.
    -f, --force             Do not check if a program is installed (always
                            enabled with --program).
    -n, --no, --simulate    Do not actually make any filesystem changes.
    -v, --verbose           Increase verbosity.
    -h, --help              Show this help.

Examples:
    Stow every dotfiles for all installed programs (reading dotfiles from the
    current directory):
        $0 up

    Stow every dotfiles for all programs (reading dotfiles from the current
    directory):
        $0 up --force

    Stow every dotfiles for "bash" and "vim", reading dotfiles from the
    directory ~/dotfiles:
        $0 -d ~/dotfiles -p bash -p vim up

    Unstow every dotfiles for "vim" (reading dotfiles from the current
    directory):
        $0 down -p vim
HELP
}

should_stow() {
  local program="$1"

  [[ "$(command -v "${program}")" ]] \
    || [[ -d "/etc/${program}" ]] \
    || return 1
}

if [[ $# -lt 1 ]]; then
  printf "Invalid command: wrong number of arguments.\n"
  print_help
  exit 1
fi

command="$1"; shift
stow_action=""
dotfile_dir=$(pwd)
programs=()
force=false
list=false

case ${command} in
  up)
    stow_action="--stow"
    ;;
  down)
    stow_action="--delete"
    force=true
    ;;
  list)
    list=true
    ;;
  -h|--help)
    print_help
    exit 0
    ;;
  *)
    printf "Invalid command: %s.\n" "${command}"
    print_help
    exit 1
esac

while [[ $# -gt 0 ]]; do
  case $1 in
    -d|--dir)
      dotfile_dir=$2
      shift; shift
      ;;
    -p|--program)
      programs+=( "$2" )
      shift; shift
      ;;
    -f|--force)
      force=true
      shift
      ;;
    -n|--no|--simulate)
      stow_options+=( "$1" )
      shift
      ;;
    -v|--verbose)
      stow_options+=( "--verbose" )
      shift
      ;;
    -h|--help)
      print_help
      exit 0
      ;;
    *)
      printf "Invalid option: %s.\n" "$1"
      print_help
      exit 1
  esac
done

if [[ ! -d "${dotfile_dir}" ]]; then
  printf "Invalid argument: missing directory %s.\n" "${dotfile_dir}"
  print_help
  exit 1
fi

for target_desc in "${STOW_TARGETS[@]}"; do
  IFS=: read -r stow_dirname target_dir <<< "${target_desc}"

  stow_dir="${dotfile_dir}/${stow_dirname}"
  if [[ ! -d "${stow_dir}" ]]; then continue; fi

  todo_programs=()
  if [[ ${#programs[@]} -gt 0 ]]; then
    for program in "${programs[@]}"; do
      if [[ -d "${stow_dir}/${program}" ]]; then
        todo_programs+=( "${program}" )
      fi
    done
  else
    for program in "${stow_dir}"/*; do
      program=$(basename "${program}")
      if ${force} || should_stow "${program}"; then
        todo_programs+=( "${program}" )
      fi
    done
  fi

  for program in "${todo_programs[@]}"; do
    if ${list}; then
      printf "%s (%s)\n" "${program}" "${stow_dirname}"
      continue
    fi

    action_msg="Managing dotfiles of \"${program}\" (wd=${target_dir})..."
    printf "%s\n" "${action_msg}"

    if stow \
      ${stow_options[@]} \
      --dir "${stow_dir}" \
      --target "${target_dir}" \
      ${stow_action} "${program}"; then
      printf "%s \033[32mdone\033[0m\n" "${action_msg}"
    else
      printf "%s \033[31merror\033[0m\n" "${action_msg}"
    fi
  done
done
